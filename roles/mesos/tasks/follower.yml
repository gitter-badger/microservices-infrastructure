---
- name: disable mesos leader
  become: yes
  service:
    name: mesos-master
    enabled: no
  when: mesos_mode == "follower"
  tags:
    - mesos

- name: set containerizers
  become: yes
  copy:
    content: "docker,mesos"
    dest: /etc/mesos-slave/containerizers
  notify: restart mesos follower
  tags:
    - mesos

- name: set ip
  become: yes
  copy:
    content: "{{ private_ipv4 }}"
    dest: /etc/mesos-slave/ip
  notify: restart mesos follower
  tags:
    - mesos

- name: write credential
  when: do_mesos_follower_auth|bool
  become: yes
  copy:
    dest: /etc/mesos/follower-credential
    content: "{{ mesos_follower_principal }} {{ mesos_follower_secret }}"
    mode: 0600
  notify: restart mesos follower
  tags:
    - mesos

- name: delete credential
  when: not do_mesos_follower_auth|bool
  become: yes
  file:
    dest: /etc/mesos/follower-credential
    state: absent
  notify: restart mesos follower
  tags:
    - mesos

- name: enable credential option
  when: do_mesos_follower_auth|bool
  become: yes
  copy:
    dest: /etc/mesos-slave/credential
    content: /etc/mesos/follower-credential
  notify: restart mesos follower
  tags:
    - mesos

- name: disable credential option
  when: not do_mesos_follower_auth|bool
  become: yes
  file:
    dest: /etc/mesos-slave/credential
    state: absent
  notify: restart mesos follower
  tags:
    - mesos

- name: set executor registration timeout
  become: yes
  copy:
    dest: /etc/mesos-slave/executor_registration_timeout
    content: "{{ mesos_executor_registration_timeout }}"
  notify: restart mesos follower
  tags:
    - mesos

- name: set follower resources
  become: yes
  copy:
    dest: /etc/mesos-slave/resources
    content: "{{ mesos_resources }}"
  notify: remove mesos follower metadata
  tags:
    - mesos

- name: set follower node id
  become: yes
  copy:
    dest: /etc/mesos-slave/attributes
    content: "node_id:{{ inventory_hostname }}"
  notify: remove mesos follower metadata
  tags:
    - mesos

- name: install collectd mesos-slave plugin
  become: yes
  copy:
    src: mesos-slave.py
    dest: /usr/share/collectd/plugins
    mode: 0400
  tags:
    - mesos
    - collectd

- name: configure collectd mesos-slave plugin
  become: yes
  template:
    src: mesos-slave.conf.j2
    dest: /etc/collectd.d/mesos-slave.conf
  notify:
    - restart collectd
  tags:
    - mesos
    - collectd
