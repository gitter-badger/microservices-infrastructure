---
# default is etc/utc in build 20141129 [http://cloud.centos.org/centos/7/images/]
- name: set timezone to etc/utc
  become: yes
  file:
    src: /usr/share/zoneinfo/Etc/UTC
    dest: /etc/localtime
    state: link
    force: yes

# add hosts to /etc/hosts
- name: configure hosts file
  become: yes
  lineinfile:
    dest: /etc/hosts
    regexp: "^{{ hostvars[item].private_ipv4 }} {{ item }}{% if use_host_domain %} {{ item }}.{{ host_domain }}{% endif %}$"
    line: "{{ hostvars[item].private_ipv4 }} {{ item }}{% if use_host_domain %} {{ item }}.{{ host_domain}}{% endif %}"
    state: present
  when: hostvars[item].private_ipv4 is defined
  with_items: groups['all']

- name: clean hosts file
  become: yes
  lineinfile:
    dest: /etc/hosts
    regexp: "{{ item }}"
    state: absent
  with_items:
    - '^127\.0\.0\.1(\s+){{ inventory_hostname }}.*'
    - '^::1(\s+){{ inventory_hostname }}.*'

- name: install system utilities
  become: yes
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - httpd-tools
    - nc
    - openssh
    - policycoreutils-python
    - unzip
  tags:
    - bootstrap

- name: disable firewalld
  become: yes
  service:
    name: firewalld
    enabled: false
    state: stopped
  register: command_result
  failed_when: "command_result|failed and 'No such file or directory' not in command_result.msg"

- name: Install build essentials
  yum: name="@Development tools"
  become: yes

- name: Install Python development package
  yum: name=python-devel
  become: yes

- name: Install OpenSSL development package
  yum: name=openssl-devel
  become: yes

- name: install pip and other dependencies
  become: yes
  yum:
    name: "{{ item.name }}"
    state: latest
  with_items:
    - name: python-pip
    - name: libffi-devel

- name: update setuptools and pip
  become: yes
  pip:
    name: "{{ item.name }}"
    state: latest
    extra_args: '--proxy https://tel-proxy.yaanatech.net:3128'
  with_items:
    - name: pip
    - name: setuptools

- name: install PyOpenSSL
  become: yes
  pip:
    name: "{{ item.name }}"
    state: latest
    extra_args: '--proxy https://tel-proxy.yaanatech.net:3128'
  with_items:
    - name: pyopenssl 
    - name: ndg-httpsclient 
    - name: pyasn1

- name: install distributive
  become: yes
  yum:
    name: "distributive"
    state: present
  tags:
    - distributive

- name: turn off abrt-ccpp
  become: yes
  service:
    name: abrt-ccpp
    state: stopped
    enabled: no

- include: users.yml
- include: ssl.yml
